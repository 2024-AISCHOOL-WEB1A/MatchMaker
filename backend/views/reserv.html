

{% block content %}

<link rel="stylesheet" href="/css/reserv.css">

<h1>ğŸ™ì˜ˆì•½í•˜ê¸°ğŸ™</h1>

<form id="fieldForm" action="/reserv/reservAll" method="get">
    <input type="hidden" name="match_idx" value="{{ match_idx }}">
    <label for="field">í•„ë“œ:</label>
    <select id="field" name="field_idx" required onchange="submitFieldForm()">
        <option value="">í•„ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
        {% for item in fields %}
        <option value="{{ item.field_idx }}" {% if selected_field_idx==item.field_idx %} selected {% endif %}>
            {{ item.field_name }}
        </option>
        {% endfor %}
    </select><br>

    <label for="court">ì½”íŠ¸:</label>
    <select id="court" name="court_idx" required onchange="submitFieldForm()">
        <option value="">ì½”íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
        {% for item in courts %}
        <option value="{{ item.court_idx }}" {% if selected_court_idx==item.court_idx %} selected {% endif %}>
            {{ item.court_name }}
        </option>
        {% endfor %}
    </select><br>

    <label for="reserv_dt">ì˜ˆì•½ ë‚ ì§œ:</label>
    <input type="date" id="reserv_dt" name="reserv_dt" value="{{ reserv_date }}" required onchange="submitFieldForm()"><br>
</form>

<form id="reservationForm" action="/reserv/reserv" method="post">
    <input type="hidden" name="field_idx" value="{{ selected_field_idx }}">
    <input type="hidden" name="court_idx" value="{{ selected_court_idx }}">
    <input type="hidden" name="reserv_dt" value="{{ reserv_date }}">
    <input type="hidden" name="match_idx" value="{{ match_idx }}">

    <div class="time-bar-container">
        <div class="time-bar">
            {% set times = ["00:00", "01:00", "02:00", "03:00", "04:00", "05:00", "06:00", "07:00", "08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00", "21:00", "22:00", "23:00"] %}
            {% set min_time = field_oper_st_time.split(':')[0]|int %}
            {% set max_time = field_oper_ed_time.split(':')[0]|int %}
            {% set is_24_hours = (min_time == 0 and max_time == 0) %}

            {% for time in times %}
                {% set hour = time.split(':')[0]|int %}
                {% set is_disabled = ((is_24_hours != is_24_hours) and (hour < min_time or max_time <= hour)) %}
                {% for reserv in reservations %}
                    {% set reserv_st_tm = reserv.reserv_st_tm.split(':')[0]|int %}
                    {% set reserv_ed_tm = reserv.reserv_ed_tm.split(':')[0]|int %}
                    {% if reserv.reserv_dt == reserv_date and (reserv_st_tm <= hour and hour < reserv_ed_tm) %}
                        {% set is_disabled = true %}
                    {% endif %}
                {% endfor %}
                <div class="time-slot {% if is_disabled %}disabled{% else %}enabled{% endif %}" data-time="{{ time }}">
                    <span class="time-label">{{ time }}</span>
                </div>
            {% endfor %}
        </div>
    </div>

    <button type="submit">ì˜ˆì•½í•˜ê¸°</button>
</form>

<script>
    function submitFieldForm() {
        const fieldForm = document.getElementById('fieldForm');
        fieldForm.submit();
    }

    document.addEventListener('DOMContentLoaded', function () {
        const reservDateInput = document.getElementById('reserv_dt');
        const timeSlots = document.querySelectorAll('.time-slot');
        const minTimeStr = "{{ field_oper_st_time }}";
        const maxTimeStr = "{{ field_oper_ed_time }}";
        const reservDateStr = "{{ reserv_date }}";
        const currentDateStr = "{{ current_date }}";
        const currentTimeStr = "{{ current_time }}";

        // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
        const today = new Date().toISOString().split('T')[0];
        
        // ë‚ ì§œ ì…ë ¥ í•„ë“œì˜ ìµœì†Œê°’ì„ ì˜¤ëŠ˜ë¡œ ì„¤ì •
        reservDateInput.min = today;

        const is24Hours = (minTimeStr === "00:00:00" && maxTimeStr === "00:00:00");

        const now = new Date();
        const reservDate = new Date(reservDateStr);
        const currentDate = new Date(currentDateStr);
        const currentHour = now.getHours();

        timeSlots.forEach(slot => {
            const timeValue = parseInt(slot.getAttribute('data-time').split(':')[0], 10);

            if (!is24Hours) {
                const minTime = parseInt(minTimeStr.split(':')[0], 10);
                const maxTime = parseInt(maxTimeStr.split(':')[0], 10);

                if (timeValue < minTime || timeValue >= maxTime) {
                    slot.classList.add('disabled');
                }
            }

            // ì˜¤ëŠ˜ ë‚ ì§œì— ëŒ€í•´ì„œë§Œ ê³¼ê±° ì‹œê°„ ë¹„í™œì„±í™”
            if (reservDateStr === currentDateStr && timeValue <= currentHour) {
                slot.classList.add('disabled');
            }

            slot.addEventListener('click', function() {
                if (!slot.classList.contains('disabled')) {
                    slot.classList.toggle('selected');
                    updateSlots();
                }
            });
        });

        reservationForm.addEventListener('submit', function(event) {

            // ì„ íƒëœ ì‹œê°„ ìŠ¬ë¡¯ì˜ ê°’ì„ formì— ì¶”ê°€
            const selectedSlots = document.querySelectorAll('.time-slot.selected');
            selectedSlots.forEach(slot => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'reserv_tm';
                input.value = slot.getAttribute('data-time');
                reservationForm.appendChild(input);
            });
        });
        
    });

    function updateSlots() {
        const timeSlots = document.querySelectorAll('.time-slot');
        let startChecked = null;
        let endChecked = null;

        timeSlots.forEach((slot, index) => {
            if (slot.classList.contains('selected')) {
                if (startChecked === null) {
                    startChecked = index;
                }
                endChecked = index;
            }
        });

        if (startChecked !== null && endChecked !== null) {
            for (let i = startChecked; i <= endChecked; i++) {
                if (timeSlots[i].classList.contains('disabled')) {
                    alert("ì„ íƒí•œ ë²”ìœ„ ë‚´ì— ì˜ˆì•½í•  ìˆ˜ ì—†ëŠ” ì‹œê°„ì´ ìˆìŠµë‹ˆë‹¤.");
                    timeSlots.forEach(slot => slot.classList.remove('selected'));
                    return;
                }
                timeSlots[i].classList.add('selected');
            }
        }
    }
</script>

{% endblock %}
